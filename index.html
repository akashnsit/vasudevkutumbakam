<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Earth's Breathing Tree - Vasudhaiva Kutumbakam</title>
  <link href="https://fonts.googleapis.com/css2?family=Lora&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background-color: #fff;
      font-family: 'Lora', serif;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      text-align: center;
      padding: 2rem;
    }

    header h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    header p {
      font-size: 1.1rem;
      color: #555;
    }

    #pollution-data {
      margin-top: 1rem;
      font-size: 1rem;
      color: #444;
      max-width: 600px;
      text-align: left;
    }

    canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <header>
    <h1>Earth's Breathing Tree</h1>
    <p>Vasudhaiva Kutumbakam - The world is one family</p>
    <div id="pollution-data">Loading pollution data...</div>
  </header>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <script>
    let pollutionAverages = {};
    let status = 'loading';

    async function fetchPollution() {
      const pollutants = ['pm25', 'pm10', 'no2', 'so2', 'co', 'o3'];
      const promises = pollutants.map(async (param) => {
        const res = await fetch(`https://api.openaq.org/v2/measurements?limit=100&page=1&sort=desc&parameter=${param}`);
        const data = await res.json();
        const values = data.results.map(d => d.value);
        const avg = values.reduce((a, b) => a + b, 0) / values.length;
        pollutionAverages[param.toUpperCase()] = avg.toFixed(2);
      });

      try {
        await Promise.all(promises);
        const pm25 = parseFloat(pollutionAverages['PM25']);
        status = getStatus(pm25);

        const mitigationRate = (100 - (pm25 / 35.4) * 100).toFixed(2); // Assuming 35.4 µg/m³ is danger threshold

        document.getElementById('pollution-data').innerHTML = `
          <strong>Current Global Pollution Levels (µg/m³):</strong><br>
          PM2.5: ${pollutionAverages['PM25']}<br>
          PM10: ${pollutionAverages['PM10']}<br>
          NO₂: ${pollutionAverages['NO2']}<br>
          SO₂: ${pollutionAverages['SO2']}<br>
          CO: ${pollutionAverages['CO']}<br>
          O₃: ${pollutionAverages['O3']}<br><br>
          <strong>Earth's Natural Mitigation Rate:</strong> ${mitigationRate}%
        `;

        redraw();
      } catch (err) {
        document.getElementById('pollution-data').textContent = 'Failed to load pollution data';
        status = 'unknown';
        redraw();
      }
    }

    function getStatus(pm25Avg) {
      if (pm25Avg <= 12) return 'green';
      if (pm25Avg > 12 && pm25Avg <= 25) return 'mixed';
      return 'brown';
    }

    function setup() {
      createCanvas(windowWidth, 600);
      noLoop();
      fetchPollution();
      setInterval(fetchPollution, 60000); // auto-refresh every minute
    }

    function draw() {
      clear();
      background(255);

      // draw trunk
      stroke(80, 50, 30);
      strokeWeight(20);
      line(width / 2, height, width / 2, height - 200);

      // draw leaves
      const totalLeaves = 200;
      noStroke();
      for (let i = 0; i < totalLeaves; i++) {
        const angle = random(TWO_PI);
        const radius = random(60, 180);
        const x = width / 2 + cos(angle) * radius;
        const y = height - 200 + sin(angle) * radius;

        if (status === 'green') fill(34, 139, 34, 180); // forest green
        else if (status === 'brown') fill(139, 69, 19, 180); // saddle brown
        else if (status === 'mixed') fill(lerpColor(color(139, 69, 19), color(34, 139, 34), random()));
        else fill(120);

        ellipse(x, y, random(12, 18), random(16, 24));
      }
    }

    function windowResized() {
      resizeCanvas(windowWidth, 600);
      redraw();
    }
  </script>
</body>
</html>
