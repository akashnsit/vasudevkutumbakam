<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Earth's Breathing Tree - Vasudhaiva Kutumbakam</title>
  <link href="https://fonts.googleapis.com/css2?family=Lora&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background-color: #fff;
      font-family: 'Lora', serif;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      text-align: center;
      padding: 2rem;
    }

    header h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    header p {
      font-size: 1.1rem;
      color: #555;
    }

    #pollution-data {
      margin-top: 1rem;
      font-size: 1rem;
      color: #444;
      max-width: 600px;
      text-align: left;
    }

    canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <header>
    <h1>Earth's Breathing Tree</h1>
    <p>Vasudhaiva Kutumbakam - The world is one family</p>
    <div id="pollution-data">Loading pollution data...</div>
  </header>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <script>
    let pollutionAverages = {};
    let status = 'loading';
    let treeImg;

    function preload() {
      treeImg = loadImage('/mnt/data/stock-vector-big-banyan-tree-eps-old-tree-2101700290.jpg');
    }

    async function fetchPollution() {
      const pollutants = ['pm25', 'pm10', 'no2', 'so2', 'co', 'o3'];
      const promises = pollutants.map(async (param) => {
        const url = `https://api.openaq.org/v2/measurements?limit=100&page=1&sort=desc&parameter=${param}`;
        const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
        const res = await fetch(proxy);
        const parsed = JSON.parse(await res.text());
        const data = JSON.parse(parsed.contents);
        const values = data.results.map(d => d.value);
        const avg = values.reduce((a, b) => a + b, 0) / values.length;
        pollutionAverages[param.toUpperCase()] = avg.toFixed(2);
      });

      try {
        await Promise.all(promises);
        const pm25 = parseFloat(pollutionAverages['PM25']);
        status = getStatus(pm25);

        const mitigationRate = (100 - (pm25 / 35.4) * 100).toFixed(2); // Assuming 35.4 µg/m³ is danger threshold

        document.getElementById('pollution-data').innerHTML = `
          <strong>Current Global Pollution Levels (µg/m³):</strong><br>
          PM2.5: ${pollutionAverages['PM25']}<br>
          PM10: ${pollutionAverages['PM10']}<br>
          NO₂: ${pollutionAverages['NO2']}<br>
          SO₂: ${pollutionAverages['SO2']}<br>
          CO: ${pollutionAverages['CO']}<br>
          O₃: ${pollutionAverages['O3']}<br><br>
          <strong>Earth's Natural Mitigation Rate:</strong> ${mitigationRate}%
        `;

        redraw();
      } catch (err) {
        document.getElementById('pollution-data').textContent = 'Failed to load pollution data';
        status = 'unknown';
        redraw();
      }
    }

    function getStatus(pm25Avg) {
      if (pm25Avg <= 12) return 'green';
      if (pm25Avg > 12 && pm25Avg <= 25) return 'mixed';
      return 'brown';
    }

    function setup() {
      createCanvas(windowWidth, 600);
      noLoop();
      fetchPollution();
      setInterval(fetchPollution, 60000);
    }

    function draw() {
      clear();
      background(255);
      imageMode(CENTER);
      image(treeImg, width / 2, height / 2 + 50, 500, 400);

      const leafColor =
        status === 'green' ? color(34, 139, 34, 180) :
        status === 'brown' ? color(139, 69, 19, 180) :
        status === 'mixed' ? null : color(100);

      noStroke();
      for (let i = 0; i < 200; i++) {
        const x = random(width / 2 - 200, width / 2 + 200);
        const y = random(height / 2 - 100, height / 2 + 100);
        if (status === 'mixed') fill(lerpColor(color(139, 69, 19), color(34, 139, 34), random()));
        else fill(leafColor);
        ellipse(x, y, random(8, 14), random(10, 16));
      }
    }

    function windowResized() {
      resizeCanvas(windowWidth, 600);
      redraw();
    }
  </script>
</body>
</html>

